\doxysection{Ble\+Protocol.\+js}
\hypertarget{_ble_protocol_8js_source}{}\label{_ble_protocol_8js_source}\index{src/api/BleProtocol.js@{src/api/BleProtocol.js}}
\mbox{\hyperlink{_ble_protocol_8js}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00001}00001\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00005}00005\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00006}\mbox{\hyperlink{_ble_protocol_8js_a59be084da8908b7d77ff34b25cd84488}{00006}}\ \textcolor{keyword}{import}\ \{\ Buffer\ \}\ from\ \textcolor{stringliteral}{'buffer'};}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00012}\mbox{\hyperlink{_ble_protocol_8js_aaa9370ecf93092946eab9785db4130ad}{00012}}\ export\ \textcolor{keyword}{const}\ \mbox{\hyperlink{_ble_protocol_8js_aaa9370ecf93092946eab9785db4130ad}{SENSOR\_UUIDS}}\ =\ \{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00013}00013\ \ \ SERVICE:\ \textcolor{stringliteral}{"{}0000180D-\/0000-\/1000-\/8000-\/00805F9B34FB"{}},\ \textcolor{comment}{//\ Replace\ with\ actual\ Service\ UUID}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00014}00014\ \ \ WRITE\_CHAR:\ \textcolor{stringliteral}{"{}00002A37-\/0000-\/1000-\/8000-\/00805F9B34FB"{}},\ \textcolor{comment}{//\ Replace\ with\ Write\ Char\ UUID}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00015}00015\ \ \ NOTIFY\_CHAR:\ \textcolor{stringliteral}{"{}00002A38-\/0000-\/1000-\/8000-\/00805F9B34FB"{}},\ \textcolor{comment}{//\ Replace\ with\ Notify\ Char\ UUID}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00016}00016\ \};}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00022}\mbox{\hyperlink{_ble_protocol_8js_abc27c9cc8340665795da2ecca7e02241}{00022}}\ export\ \textcolor{keyword}{const}\ \mbox{\hyperlink{_ble_protocol_8js_abc27c9cc8340665795da2ecca7e02241}{COMMANDS}}\ =\ \{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00023}00023\ \ \ CMD\_SYS\_PARAM\_READ:\ 0x01,\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00024}00024\ \ \ CMD\_SYS\_SETTING\_SET:\ 0x08,\ \ \ \ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00025}00025\ \ \ CMD\_SCAN\_START:\ 0x18,\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00026}00026\ \ \ CMD\_SCAN\_STOP:\ 0x1F,\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00027}00027\ \ \ RES\_SYS\_UNSOLICITED:\ 0x8E\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00028}00028\ \};}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00029}00029\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00033}\mbox{\hyperlink{_ble_protocol_8js_afdf6cb6c172056ebcedb95358dde10ef}{00033}}\ export\ \textcolor{keyword}{const}\ \mbox{\hyperlink{_ble_protocol_8js_afdf6cb6c172056ebcedb95358dde10ef}{SYS\_MODES}}\ =\ \{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00034}00034\ \ \ RESULT\_ONLY:\ 0x31,}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00035}00035\ \ \ RAW\_ONLY:\ 0x32,}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00036}00036\ \ \ BOTH:\ 0x33}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00037}00037\ \};}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00045}\mbox{\hyperlink{_ble_protocol_8js_a5d42c2f603df43380cc8ec242a55d4e1}{00045}}\ export\ \textcolor{keyword}{const}\ \mbox{\hyperlink{_ble_protocol_8js_a5d42c2f603df43380cc8ec242a55d4e1}{buildSysSettingCmd}}\ =\ (mode,\ freq)\ =>\ \{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00046}00046\ \ \ \textcolor{keyword}{const}\ buffer\ =\ Buffer.alloc(3);}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00047}00047\ \ \ buffer.writeUInt8(\mbox{\hyperlink{_ble_protocol_8js_abc27c9cc8340665795da2ecca7e02241}{COMMANDS}}.CMD\_SYS\_SETTING\_SET,\ 0);}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00048}00048\ \ \ buffer.writeUInt8(mode,\ 1);}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00049}00049\ \ \ buffer.writeUInt8(freq,\ 2);}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00050}00050\ \ \ \textcolor{keywordflow}{return}\ buffer.toString(\textcolor{stringliteral}{'base64'});}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00051}00051\ \};}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00058}\mbox{\hyperlink{_ble_protocol_8js_afde1b1380963e8b37fd1b05cebae9d7b}{00058}}\ export\ \textcolor{keyword}{const}\ \mbox{\hyperlink{_ble_protocol_8js_afde1b1380963e8b37fd1b05cebae9d7b}{buildSimpleCmd}}\ =\ (cmdId)\ =>\ \{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00059}00059\ \ \ \textcolor{keyword}{const}\ buffer\ =\ Buffer.alloc(1);}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00060}00060\ \ \ buffer.writeUInt8(cmdId,\ 0);}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00061}00061\ \ \ \textcolor{keywordflow}{return}\ buffer.toString(\textcolor{stringliteral}{'base64'});}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00062}00062\ \};}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00063}00063\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00071}\mbox{\hyperlink{_ble_protocol_8js_af6879cd2fe3d7951ea64f81be0b7617e}{00071}}\ export\ \textcolor{keyword}{const}\ \mbox{\hyperlink{_ble_protocol_8js_af6879cd2fe3d7951ea64f81be0b7617e}{parseNotification}}\ =\ (base64Data)\ =>\ \{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00072}00072\ \ \ \textcolor{keyword}{const}\ buffer\ =\ Buffer.from(base64Data,\ \textcolor{stringliteral}{'base64'});}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00073}00073\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00074}00074\ \ \ \textcolor{comment}{//\ Basic\ validation:\ Check\ if\ it's\ the\ right\ unsolicited\ packet\ or\ raw\ data\ stream}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00075}00075\ \ \ \textcolor{comment}{//\ Note:\ Depending\ on\ firmware,\ the\ 0x8E\ header\ might\ be\ present\ or\ stripped.}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00076}00076\ \ \ \textcolor{comment}{//\ We\ assume\ here\ the\ payload\ contains\ the\ 0x8E\ header\ byte\ followed\ by\ data.}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00077}00077\ \ \ \textcolor{comment}{//\ Total\ size\ for\ 2\ sets\ of\ 3x16-\/bit\ values\ =\ 12\ bytes\ +\ header\ (approx\ 2\ bytes)}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00078}00078\ \ \ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00079}00079\ \ \ let\ offset\ =\ 0;}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00080}00080\ \ \ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00081}00081\ \ \ \textcolor{comment}{//\ If\ the\ first\ byte\ is\ the\ Unsolicited\ Response\ Code\ (0x8E)}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00082}00082\ \ \ \textcolor{keywordflow}{if}\ (buffer[0]\ ===\ \mbox{\hyperlink{_ble_protocol_8js_abc27c9cc8340665795da2ecca7e02241}{COMMANDS}}.RES\_SYS\_UNSOLICITED)\ \{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00083}00083\ \ \ \ \ offset\ =\ 2;\ \textcolor{comment}{//\ Skip\ Command\ (1)\ and\ potentially\ Type/Length\ (1)\ -\/\ adjust\ based\ on\ actual\ dump}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00084}00084\ \ \ \}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00085}00085\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00086}00086\ \ \ \textcolor{comment}{//\ Ensure\ we\ have\ enough\ bytes\ for\ 2\ sets\ of\ (3\ *\ 2\ bytes)\ =\ 12\ bytes}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00087}00087\ \ \ \textcolor{keywordflow}{if}\ (buffer.length\ <\ offset\ +\ 12)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{null};}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00088}00088\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00089}00089\ \ \ \textcolor{keyword}{const}\ dataPoints\ =\ [];}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00090}00090\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00091}00091\ \ \ \textcolor{comment}{//\ Parse\ Set\ 1}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00092}00092\ \ \ dataPoints.push(\{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00093}00093\ \ \ \ \ ppgIr:\ buffer.readUInt16BE(offset),}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00094}00094\ \ \ \ \ ppgRed:\ buffer.readUInt16BE(offset\ +\ 2),}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00095}00095\ \ \ \ \ ecg:\ buffer.readUInt16BE(offset\ +\ 4),}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00096}00096\ \ \ \});}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00097}00097\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00098}00098\ \ \ \textcolor{comment}{//\ Parse\ Set\ 2}}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00099}00099\ \ \ dataPoints.push(\{}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00100}00100\ \ \ \ \ ppgIr:\ buffer.readUInt16BE(offset\ +\ 6),}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00101}00101\ \ \ \ \ ppgRed:\ buffer.readUInt16BE(offset\ +\ 8),}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00102}00102\ \ \ \ \ ecg:\ buffer.readUInt16BE(offset\ +\ 10),}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00103}00103\ \ \ \});}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00105}00105\ \ \ \textcolor{keywordflow}{return}\ dataPoints;}
\DoxyCodeLine{\Hypertarget{_ble_protocol_8js_source_l00106}00106\ \};}

\end{DoxyCode}
